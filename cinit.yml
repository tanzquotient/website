programs:
  # RTFM: https://gitlab.com/veenj/cinit/-/blob/master/doc/README.md#arguments
  - name: map-envvars
    path: /app/scripts/generate_env_sip.sh
    workdir: /app
    user: app-user
    before:
      - pre-start
      - post-start
      - gunicorn
      - celery-beat
      - celery-worker
    env:
      - SIP_TQ_DJANGO_DEBUG:
      - SIP_TQ_ENVIRONMENT:
      - SIP_TQ_ALLOWED_HOSTS:
      - SIP_TQ_DJANGO_SECRET_KEY:
      # Postgres
      - SIP_POSTGRES_TQ_WEBSITE_SERVER:
      - SIP_POSTGRES_TQ_WEBSITE_PORT:
      - SIP_POSTGRES_TQ_WEBSITE_NAME:
      - SIP_POSTGRES_TQ_WEBSITE_USER:
      - SIP_POSTGRES_TQ_WEBSITE_PW:
      # S3 storage
      - SIP_S3_TQ_MEDIA_BUCKET:
      - SIP_S3_TQ_MEDIA_HOST:
      - SIP_S3_TQ_MEDIA_PORT:
      - SIP_S3_TQ_MEDIA_USE_SSL:
      - SIP_S3_TQ_MEDIA_ACCESS_KEY:
      - SIP_S3_TQ_MEDIA_SECRET_KEY:
      - SIP_S3_TQ_STATIC_BUCKET:
      - SIP_S3_TQ_STATIC_HOST:
      - SIP_S3_TQ_STATIC_PORT:
      - SIP_S3_TQ_STATIC_USE_SSL:
      - SIP_S3_TQ_STATIC_ACCESS_KEY:
      - SIP_S3_TQ_STATIC_SECRET_KEY:
      - SIP_S3_TQ_POSTFINANCE_BUCKET:
      - SIP_S3_TQ_POSTFINANCE_HOST:
      - SIP_S3_TQ_POSTFINANCE_PORT:
      - SIP_S3_TQ_POSTFINANCE_USE_SSL:
      - SIP_S3_TQ_POSTFINANCE_ACCESS_KEY:
      - SIP_S3_TQ_POSTFINANCE_SECRET_KEY:
      # Redis
      - SIP_TQ_REDIS_URL:
      # Email
      # TODO (#272) Migrate to SIP' smtp
      - SIP_SMTP_TQ_MAIL_HOST:
      - SIP_SMTP_TQ_MAIL_PORT:
      - SIP_SMTP_TQ_MAIL_USE_TLS:
      - SIP_SMTP_TQ_MAIL_ENCRYPTION:
      - SIP_SMTP_TQ_MAIL_MAIL_USER:
      - SIP_SMTP_TQ_MAIL_MAIL_PW:
      - SIP_SMTP_TQ_MAIL_FROM_MAIL:
      # Analytics
      - SIP_TQ_GOOGLE_ANALYTICS_PROPERTY_ID:
      # Account details
      - SIP_TQ_PAYMENT_ACCOUNT_IBAN:
      - SIP_TQ_PAYMENT_ACCOUNT_SWIFT:
      - SIP_TQ_PAYMENT_ACCOUNT_POST_NUMBER:
      - SIP_TQ_PAYMENT_ACCOUNT_RECIPIENT:
      - SIP_TQ_PAYMENT_ACCOUNT_RECIPIENT_ZIPCODE_CITY:
      # OpenID-Connect
      - SIP_AUTH_OIDC_AUTH_ENDPOINT:
      - SIP_AUTH_OIDC_TOKEN_ENDPOINT:
      - SIP_AUTH_OIDC_JWKS_URL:
      - SIP_AUTH_WEBSITE_CLIENT_ID:
      - SIP_AUTH_WEBSITE_CLIENT_SECRET:

  - name: pre-start
    path: /app/scripts/pre-start.sh
    workdir: /app
    user: app-user
    args: []
    before:
      - gunicorn
      - post-start
      - celery-beat
      - celery-worker
    # env: no need, gets everything from the .env generated by map-envvars

  - name: post-start
    path: /app/scripts/post-start.sh
    workdir: /app
    user: app-user
    args: []

  - name: gunicorn
    path: /usr/local/bin/gunicorn
    workdir: /app
    user: app-user
    args:
      - "--bind=0.0.0.0:8080"
      - "--workers=4"
      - "--timeout=30"
      - "tq_website.wsgi:application"
    # env: no need, gets everything from the .env generated by map-envvars

  - name: celery-beat
    path: /usr/local/bin/celery
    workdir: /app
    user: app-user
    args:
      - "--app=tq_website"
      - "beat"
      - "--loglevel=info"
      - "--scheduler=django"
    # env: TODO

  - name: celery-worker
    path: /usr/local/bin/celery
    workdir: /app
    user: app-user
    args:
      - "--app=tq_website"
      - "worker"
      - "--loglevel=info"
    # env: TODO
